#!/usr/bin/env bash

set -e

image="harmony/gdal"
tag=${1:-latest}

for dep in harmony-service-lib-py; do
  if [ -d "../$dep" ]; then
    rm -rf deps/$dep
    mkdir -p deps
    cp -R ../$dep deps/
    (cd deps/$dep && make clean)
  else
    [ ! -d "deps/$dep" ] && git clone https://git.earthdata.nasa.gov/scm/harmony/$dep.git deps/$dep
  fi
done

# Check whether we need a child or sibling (DIND) container. This is a hack;
#   alternative implementations welcome.
if cat /proc/1/cgroup | grep cpuset | grep -q docker; then
  docker -H host.docker.internal:2375 build -t ${image}:${tag} .
else
  docker build -t ${image}:${tag} .
fi